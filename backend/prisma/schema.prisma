// BTC Miner Valuation Terminal - Database Schema
// Site → Campus → Building → UsePeriod hierarchy

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// CORE ENTITIES
// ===========================================

model Company {
  ticker          String   @id @db.VarChar(10)
  name            String   @db.VarChar(255)
  archived        Boolean  @default(false)

  // Balance Sheet
  btcHoldings     Decimal? @db.Decimal(18, 8)
  btcCount        Decimal? @db.Decimal(18, 8)
  ethHoldings     Decimal? @db.Decimal(18, 8)
  cashM           Decimal? @db.Decimal(12, 2)
  debtM           Decimal? @db.Decimal(12, 2)
  fdSharesM       Decimal? @db.Decimal(12, 4)

  // Market Data
  stockPrice      Decimal? @db.Decimal(10, 4)

  // Mining Data
  hashrateEh      Decimal? @db.Decimal(10, 2)
  efficiencyJth   Decimal? @db.Decimal(6, 2)
  powerCostKwh    Decimal? @db.Decimal(6, 4)

  // Monitoring
  irPageUrl       String?
  twitterAccounts String[]
  sourceDate      DateTime?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  sites           Site[]
  factors         CompanyFactor[]
  debts           Debt[]

  @@map("companies")
}

// Site = Physical location (e.g., "Ellendale, ND" or "Lake Mariner, NY")
model Site {
  id              String   @id @default(uuid())
  ticker          String   @db.VarChar(10)

  // Location Info
  name            String   @db.VarChar(255)  // e.g., "Ellendale", "Lake Mariner"
  country         String   @db.VarChar(100)
  state           String?  @db.VarChar(100)
  latitude        Decimal? @db.Decimal(9, 6)
  longitude       Decimal? @db.Decimal(9, 6)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  company         Company  @relation(fields: [ticker], references: [ticker], onDelete: Cascade)
  campuses        Campus[]
  factors         SiteFactor[]

  @@unique([ticker, name])
  @@map("sites")
}

// Campus = Named development within a site (e.g., "Polaris Forge 1", "Ellendale Legacy")
model Campus {
  id              String   @id @default(uuid())
  siteId          String   @map("site_id")

  // Basic Info
  name            String   @db.VarChar(255)  // e.g., "Polaris Forge 1"

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  site            Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  buildings       Building[]

  @@unique([siteId, name])
  @@map("campuses")
}

// Building = Specific facility within a campus (e.g., "Building 1 - Phase 1", "CB-2")
model Building {
  id                  String   @id @default(uuid())
  campusId            String   @map("campus_id")
  externalId          String?  @db.VarChar(50)  // Site_ID from spreadsheet

  // Basic Info
  name                String   @db.VarChar(255)

  // Capacity
  grossMw             Decimal? @db.Decimal(10, 2)
  itMw                Decimal? @db.Decimal(10, 2)
  petaflops           Decimal? @db.Decimal(10, 2)
  pue                 Decimal? @db.Decimal(4, 2)
  grid                String?  @db.VarChar(100)

  // Ownership & Status
  ownershipStatus     String?  @db.VarChar(100)
  developmentPhase    DevelopmentPhase @default(DILIGENCE)
  energizationDate    DateTime?
  datacenterTier      DatacenterTier @default(TIER_III)

  // Valuation Control
  confidence          Confidence @default(MEDIUM)
  probabilityOverride Decimal?   @db.Decimal(3, 2)  // Manual override (0.00-1.00)
  regulatoryRisk      Decimal    @default(1.0) @db.Decimal(3, 2)  // 1.0 = no risk, 0.0 = blocked
  fidoodleFactor      Decimal    @default(1.0) @db.Decimal(4, 3)  // Custom site adjustment (0.001-9.999)
  includeInValuation  Boolean    @default(true)

  // Factor Overrides (null = use auto-derived value)
  sizeMultOverride        Decimal? @db.Decimal(4, 3)
  powerAuthMultOverride   Decimal? @db.Decimal(4, 3)
  ownershipMultOverride   Decimal? @db.Decimal(4, 3)
  tierMultOverride        Decimal? @db.Decimal(4, 3)
  capRateOverride         Decimal? @db.Decimal(5, 4)  // e.g., 0.0750 for 7.5%
  exitCapRateOverride     Decimal? @db.Decimal(5, 4)
  terminalGrowthOverride  Decimal? @db.Decimal(5, 4)
  capexPerMwOverride      Decimal? @db.Decimal(12, 2)  // CapEx $/MW override (null = use global)

  // Notes & Source
  notes               String?
  sourceUrl           String?
  sourceDate          DateTime?

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  campus              Campus   @relation(fields: [campusId], references: [id], onDelete: Cascade)
  usePeriods          UsePeriod[]

  @@map("buildings")
}

// UsePeriod = Tracks use over time (BTC Mining → HPC/AI transitions)
// Supports splits (multiple concurrent periods) and transitions (future periods)
model UsePeriod {
  id                  String   @id @default(uuid())
  buildingId          String   @map("building_id")

  // Use Info
  useType             UseType  @default(BTC_MINING)
  startDate           DateTime?
  endDate             DateTime?  // null = ongoing/no end date
  isCurrent           Boolean  @default(true)  // Active now (computed from dates or manual)

  // Capacity Allocation (for splits)
  mwAllocation        Decimal? @db.Decimal(10, 2)  // IT MW allocated to this use period

  // Lease/Tenant Details (if applicable)
  tenant              String?  @db.VarChar(255)
  tenantCreditRating  String?  @db.VarChar(50)  // Override for tenant credit lookup
  leaseStructure      LeaseStructure @default(NNN)
  leaseValueM         Decimal? @db.Decimal(12, 2)
  leaseYears          Decimal? @db.Decimal(5, 2)
  annualRevM          Decimal? @db.Decimal(12, 2)
  noiPct              Decimal? @db.Decimal(5, 4)
  noiAnnualM          Decimal? @db.Decimal(12, 2)
  leaseStart          DateTime?
  leaseEnd            DateTime?  // Calculated or explicit lease end date
  leaseNotes          String?

  // Mining-specific (for self-mining use)
  miningHashrateEh    Decimal? @db.Decimal(10, 2)
  miningEfficiencyJth Decimal? @db.Decimal(6, 2)
  miningPowerCostKwh  Decimal? @db.Decimal(6, 4)

  // CapEx override
  capexPerMwOverride  Decimal? @db.Decimal(12, 2)  // CapEx $/MW override (null = use building/global)

  // Allocation tracking
  allocationMethod    String?  @db.VarChar(50)  // Disclosed, Pro-rata, Estimated

  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  building            Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@map("use_periods")
}

// Debt tracking (from Debt worksheet)
model Debt {
  id              String   @id @default(uuid())
  ticker          String   @db.VarChar(10)

  // Instrument Info
  instrument      String   @db.VarChar(255)
  debtType        String?  @db.VarChar(100)
  issuer          String?  @db.VarChar(255)

  // Terms
  principalM      Decimal? @db.Decimal(12, 2)
  originalM       Decimal? @db.Decimal(12, 2)
  maturity        DateTime?
  couponPct       Decimal? @db.Decimal(5, 4)
  annualInterestM Decimal? @db.Decimal(12, 2)

  // Security
  secured         Boolean  @default(false)
  collateral      String?
  level           String?  @db.VarChar(50)  // Corporate, Project, Asset
  linkedSite      String?  @db.VarChar(255)

  // Convertible
  convertible     Boolean  @default(false)
  conversionPrice Decimal? @db.Decimal(10, 4)

  // Status
  status          String?  @db.VarChar(100)
  confidence      Confidence @default(MEDIUM)
  source          String?
  sourceDate      DateTime?

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  company         Company  @relation(fields: [ticker], references: [ticker], onDelete: Cascade)

  @@map("debts")
}

// ===========================================
// FACTORS (Valuation Inputs)
// ===========================================

model GlobalFactor {
  id          String   @id @default(uuid())
  category    String   @db.VarChar(50)
  key         String   @db.VarChar(50)
  value       Decimal  @db.Decimal(12, 6)
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([category, key])
  @@map("global_factors")
}

model CompanyFactor {
  id          String   @id @default(uuid())
  ticker      String   @db.VarChar(10)
  category    String   @db.VarChar(50)
  key         String   @db.VarChar(50)
  value       Decimal  @db.Decimal(12, 6)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  company     Company  @relation(fields: [ticker], references: [ticker], onDelete: Cascade)

  @@unique([ticker, category, key])
  @@map("company_factors")
}

model SiteFactor {
  id          String   @id @default(uuid())
  siteId      String   @map("site_id")
  category    String   @db.VarChar(50)
  key         String   @db.VarChar(50)
  value       Decimal  @db.Decimal(12, 6)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  site        Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@unique([siteId, category, key])
  @@map("site_factors")
}

// ===========================================
// AUDIT & SETTINGS
// ===========================================

model AuditLog {
  id          String   @id @default(uuid())
  entityType  String   @db.VarChar(50)
  entityId    String   @db.VarChar(100)
  action      AuditAction
  fieldName   String?  @db.VarChar(100)
  oldValue    Json?
  newValue    Json?
  sourceType  String?  @db.VarChar(50)
  sourceUrl   String?
  sourceDate  DateTime?
  notes       String?
  userId      String?  @db.VarChar(100)

  createdAt   DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_log")
}

model Settings {
  id              String   @id @default(uuid())
  key             String   @unique @db.VarChar(100)
  value           Json

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("settings")
}

// ===========================================
// ENUMS
// ===========================================

enum DevelopmentPhase {
  OPERATIONAL      // 100% probability (default)
  CONSTRUCTION     // 90% probability
  DEVELOPMENT      // 70% probability
  EXCLUSIVITY      // 50% probability
  DILIGENCE        // 30% probability
}

enum DatacenterTier {
  TIER_IV          // 1.15x multiplier - Fault tolerant
  TIER_III         // 1.00x multiplier - Concurrently maintainable (default)
  TIER_II          // 0.90x multiplier - Redundant capacity
  TIER_I           // 0.80x multiplier - Basic site infrastructure
}

enum LeaseStructure {
  NNN              // 1.00x - Triple Net (tenant pays all expenses)
  MODIFIED_GROSS   // 0.95x - Some expenses shared
  GROSS            // 0.90x - Landlord pays all expenses
}

enum UseType {
  BTC_MINING
  BTC_MINING_HOSTING
  HPC_AI_HOSTING
  HPC_AI_PLANNED
  GPU_CLOUD
  COLOCATION
  MIXED
  UNCONTRACTED
  UNCONTRACTED_ROFR
}

enum Confidence {
  HIGH
  MEDIUM_HIGH
  MEDIUM
  LOW
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
}

// ===========================================
// SOTP VALUATION COMPONENTS
// ===========================================

// Mining Valuation - Self-mining profitability model
// Calculates: Ann Rev = EH/s × DailyRev/EH × 365 / 1M
// Ann Power = EH/s × Eff × $/kWh × 8.76
// EBITDA = Rev - Power - Pool Fees
// Self Mining Val = MAX(0, EBITDA × Multiple)
// Hosted Val = MW × $/MW / 1000
model MiningValuation {
  id                  String   @id @default(uuid())
  ticker              String   @unique @db.VarChar(10)

  // Mining Inputs
  hashrateEh          Decimal? @db.Decimal(10, 2)  // Self-mining EH/s
  efficiencyJth       Decimal? @db.Decimal(6, 2)   // Fleet efficiency (J/TH)
  powerCostKwh        Decimal? @db.Decimal(6, 4)   // All-in electricity ($/kWh)

  // Hosted Mining
  hostedMw            Decimal? @db.Decimal(10, 2)  // Hosted mining capacity (MW)

  // Source
  sourceDate          DateTime?
  notes               String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("mining_valuations")
}

// Net Liquid Assets - Cash + Crypto holdings - Debt = Net Liquid
model NetLiquidAssets {
  id                  String   @id @default(uuid())
  ticker              String   @unique @db.VarChar(10)

  // Cash
  cashM               Decimal? @db.Decimal(12, 2)  // Cash & equivalents ($M)

  // Crypto holdings (counts - values calculated from global assumptions)
  btcCount            Decimal? @db.Decimal(18, 8)  // Bitcoin count
  ethCount            Decimal? @db.Decimal(18, 8)  // Ethereum count

  // Total Debt (can be linked from Debt table or entered manually)
  totalDebtM          Decimal? @db.Decimal(12, 2)  // Total debt ($M)

  // Source
  sourceDate          DateTime?
  notes               String?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("net_liquid_assets")
}
